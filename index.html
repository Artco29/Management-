<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP RT 04 Digital - Final Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .active-link { border-left: 4px solid #fbbf24; background: #1e3a8a; }
    </style>
</head>
<body class="bg-gray-50">

    <div class="flex min-h-screen">
        <aside id="sidebar" class="fixed inset-y-0 left-0 bg-blue-900 text-white w-64 transition-transform -translate-x-full md:translate-x-0 md:relative z-50">
            <div class="p-6">
                <h1 class="text-xl font-bold border-b border-blue-700 pb-4 text-yellow-400">ERP RT 04</h1>
                <nav class="mt-6 space-y-1">
                    <a href="#" onclick="showSection('dash')" class="block py-3 px-4 rounded hover:bg-blue-800 transition">Dashboard</a>
                    <a href="#" onclick="showSection('warga')" class="block py-3 px-4 rounded hover:bg-blue-800 transition">Data Warga</a>
                    <a href="#" onclick="showSection('status-ipl')" class="block py-3 px-4 rounded hover:bg-blue-800 transition">Cek Status Bayar</a>
                    <a href="#" onclick="showSection('bayar-ipl')" class="block py-3 px-4 rounded hover:bg-blue-800 transition">Input Bayar IPL</a>
                    <a href="#" onclick="showSection('kas')" class="block py-3 px-4 rounded hover:bg-blue-800 transition">Pengeluaran Kas</a>
                    <a href="#" onclick="showSection('komplain')" class="block py-3 px-4 rounded hover:bg-blue-800 transition">Komplain</a>
                </nav>
            </div>
        </aside>

        <div class="flex-1 flex flex-col min-w-0">
            <header class="bg-white shadow p-4 flex justify-between items-center md:px-8">
                <button onclick="toggleSidebar()" class="md:hidden p-2 text-blue-900">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
                <div id="sync-status" class="text-xs font-semibold px-3 py-1 bg-green-100 text-green-700 rounded-full">Cloud Synced</div>
            </header>

            <main class="p-4 md:p-8 overflow-y-auto">
                
                <section id="section-dash" class="content-section">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <p class="text-sm text-gray-500 font-medium">Total Warga</p>
                            <h2 id="card-warga" class="text-3xl font-bold text-gray-800">0</h2>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <p class="text-sm text-gray-500 font-medium">Kas Masuk (IPL)</p>
                            <h2 id="card-masuk" class="text-3xl font-bold text-green-600">Rp 0</h2>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <p class="text-sm text-gray-500 font-medium">Total Pengeluaran</p>
                            <h2 id="card-keluar" class="text-3xl font-bold text-red-600">Rp 0</h2>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-4 rounded-xl shadow-sm"><canvas id="chartIpl"></canvas></div>
                        <div class="bg-white p-4 rounded-xl shadow-sm"><canvas id="chartStatus"></canvas></div>
                    </div>
                </section>

                <section id="section-warga" class="content-section hidden">
                    <div class="flex justify-between mb-4">
                        <h2 class="text-xl font-bold">Database Warga</h2>
                        <div class="flex gap-2">
                            <button onclick="document.getElementById('importFile').click()" class="bg-gray-200 px-3 py-2 rounded text-sm">Impor Excel</button>
                            <input type="file" id="importFile" class="hidden" accept=".xlsx, .xls" onchange="handleImport(event)">
                            <button onclick="openWargaModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">+ Warga</button>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-50 uppercase text-xs">
                                <tr>
                                    <th class="p-4">Nama</th><th class="p-4">Alamat</th><th class="p-4">Status</th><th class="p-4">Telp</th><th class="p-4">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="list-warga"></tbody>
                        </table>
                    </div>
                </section>

                <section id="section-bayar-ipl" class="content-section hidden">
                    <h2 class="text-xl font-bold mb-4">Input Pembayaran IPL</h2>
                    <form onsubmit="savePayment(event)" class="bg-white p-6 rounded-xl shadow-sm grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label class="block text-xs font-bold mb-1">PILIH WARGA</label>
                            <select id="pay-nama" class="w-full border p-2 rounded" required></select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold mb-1">JUMLAH (RP)</label>
                            <input type="number" id="pay-jumlah" class="w-full border p-2 rounded" required>
                        </div>
                        <div class="flex items-end">
                            <button type="submit" class="w-full bg-green-600 text-white py-2 rounded font-bold">Simpan Transaksi</button>
                        </div>
                    </form>
                    <div class="flex justify-end mb-2">
                        <button onclick="exportToExcel('ipl')" class="bg-yellow-500 text-white px-3 py-1 rounded text-xs">Export ke Excel</button>
                    </div>
                    <div class="bg-white rounded shadow overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-50"><tr><th class="p-3">Nama</th><th class="p-3">Tanggal</th><th class="p-3">Jumlah</th><th class="p-3">Hapus</th></tr></thead>
                            <tbody id="list-pembayaran"></tbody>
                        </table>
                    </div>
                </section>

                <section id="section-status-ipl" class="content-section hidden">
                    <h2 class="text-xl font-bold mb-4">Monitoring Pelunasan IPL</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-red-50 border border-red-200 p-4 rounded-xl">
                            <h3 class="font-bold text-red-700 mb-3">BELUM BAYAR (MENUNGGAK)</h3>
                            <ul id="status-belum" class="space-y-2 text-sm"></ul>
                        </div>
                        <div class="bg-green-50 border border-green-200 p-4 rounded-xl">
                            <h3 class="font-bold text-green-700 mb-3">SUDAH LUNAS</h3>
                            <ul id="status-lunas" class="space-y-2 text-sm"></ul>
                        </div>
                    </div>
                </section>

                <section id="section-kas" class="content-section hidden">
                    <h2 class="text-xl font-bold mb-4">Rekap Pengeluaran Kas</h2>
                    <form onsubmit="saveExpense(event)" class="bg-white p-6 rounded-xl shadow-sm grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <select id="kas-tipe" class="border p-2 rounded">
                            <option>Perbaikan Lampu</option>
                            <option>Perbaikan CCTV</option>
                            <option>Beli Token</option>
                            <option>Lain-lain</option>
                        </select>
                        <input type="number" id="kas-jumlah" placeholder="Nominal" class="border p-2 rounded" required>
                        <button type="submit" class="bg-red-500 text-white rounded">Catat Pengeluaran</button>
                    </form>
                    <div class="flex justify-end mb-2">
                        <button onclick="exportToExcel('kas')" class="bg-blue-500 text-white px-3 py-1 rounded text-xs">Download Rekap Kas (.xlsx)</button>
                    </div>
                    <div id="list-kas" class="bg-white rounded shadow overflow-x-auto p-4"></div>
                </section>

                <section id="section-komplain" class="content-section hidden">
                    <h2 class="text-xl font-bold mb-4">Laporan Komplain Warga</h2>
                    <div id="display-komplain" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </section>

            </main>
        </div>
    </div>

    <div id="wargaModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center p-4 z-[100]">
        <div class="bg-white w-full max-w-md p-6 rounded-2xl">
            <h3 class="text-lg font-bold mb-4">Tambah Data Warga</h3>
            <input type="text" id="w-nama" placeholder="Nama Lengkap" class="w-full border mb-3 p-2 rounded">
            <input type="text" id="w-alamat" placeholder="Alamat (No. Rumah)" class="w-full border mb-3 p-2 rounded">
            <select id="w-status" class="w-full border mb-3 p-2 rounded">
                <option>Tetap</option>
                <option>Kontrak</option>
            </select>
            <input type="text" id="w-telp" placeholder="No Telepon" class="w-full border mb-4 p-2 rounded">
            <div class="flex justify-end gap-2">
                <button onclick="closeWargaModal()" class="px-4 py-2 text-gray-500">Batal</button>
                <button onclick="addWarga()" class="px-4 py-2 bg-blue-600 text-white rounded">Simpan Data</button>
            </div>
        </div>
    </div>

    <script>
        // --- KONFIGURASI JSON.IO / JSONBIN ---
        // Ganti dengan API Key Anda untuk simpan permanen cloud
        const API_KEY = '$2a$10$Z/ZTmFb7wX/LLZ3FS8cbJ.nuUe9L/IBCX2pfLqnstIhgfrqXA.Ioq'; 
        const BIN_ID = '698b359fd0ea881f40afa892';

        let appData = {
            warga: [],
            pembayaran: [],
            pengeluaran: [],
            komplain: []
        };

        // --- CORE LOGIC ---
        async function loadData() {
            const local = localStorage.getItem('rt04_erp');
            if (local) appData = JSON.parse(local);
            
            // Contoh Fetch dari JSONbin (Opsional jika API Key diisi)
            /*
            try {
                const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                    headers: { 'X-Master-Key': API_KEY }
                });
                const remoteData = await res.json();
                appData = remoteData.record;
            } catch (e) { console.log("Offline mode active"); }
            */
            
            renderAll();
        }

        async function syncToCloud() {
            localStorage.setItem('rt04_erp', JSON.stringify(appData));
            document.getElementById('sync-status').innerText = "Saving...";
            
            // Simpan ke JSONbin
            /*
            await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
                body: JSON.stringify(appData)
            });
            */
            
            renderAll();
            document.getElementById('sync-status').innerText = "Cloud Synced";
        }

        // --- NAVIGATION ---
        function showSection(id) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.add('hidden'));
            document.getElementById('section-' + id).classList.remove('hidden');
            if(window.innerWidth < 768) toggleSidebar();
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('-translate-x-full');
        }

        // --- WARGA FUNCTIONS ---
        function openWargaModal() { document.getElementById('wargaModal').classList.remove('hidden'); }
        function closeWargaModal() { document.getElementById('wargaModal').classList.add('hidden'); }

        function addWarga() {
            const w = {
                id: Date.now(),
                nama: document.getElementById('w-nama').value,
                alamat: document.getElementById('w-alamat').value,
                status: document.getElementById('w-status').value,
                telp: document.getElementById('w-telp').value
            };
            appData.warga.push(w);
            syncToCloud();
            closeWargaModal();
        }

        function handleImport(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (event) => {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(sheet);
                rows.forEach(r => {
                    appData.warga.push({ id: Date.now() + Math.random(), nama: r.Nama, alamat: r.Alamat, status: r.Status || 'Tetap', telp: r.Telp || '-' });
                });
                syncToCloud();
            };
            reader.readAsArrayBuffer(file);
        }

        // --- PEMBAYARAN FUNCTIONS ---
        function savePayment(e) {
            e.preventDefault();
            const pay = {
                id: Date.now(),
                nama: document.getElementById('pay-nama').value,
                jumlah: parseInt(document.getElementById('pay-jumlah').value),
                tgl: new Date().toLocaleDateString('id-ID')
            };
            appData.pembayaran.push(pay);
            syncToCloud();
            e.target.reset();
        }

        function deletePayment(id) {
            appData.pembayaran = appData.pembayaran.filter(p => p.id !== id);
            syncToCloud();
        }

        // --- KAS FUNCTIONS ---
        function saveExpense(e) {
            e.preventDefault();
            const exp = {
                id: Date.now(),
                tipe: document.getElementById('kas-tipe').value,
                jumlah: parseInt(document.getElementById('kas-jumlah').value),
                tgl: new Date().toLocaleDateString('id-ID')
            };
            appData.pengeluaran.push(exp);
            syncToCloud();
            e.target.reset();
        }

        // --- RENDERER ---
        function renderAll() {
            // Table Warga
            document.getElementById('list-warga').innerHTML = appData.warga.map(w => `
                <tr class="border-b">
                    <td class="p-4 font-semibold">${w.nama}</td>
                    <td class="p-4">${w.alamat}</td>
                    <td class="p-4">${w.status}</td>
                    <td class="p-4 text-gray-500">${w.telp}</td>
                    <td class="p-4"><button onclick="deleteWarga(${w.id})" class="text-red-500">Hapus</button></td>
                </tr>
            `).join('');

            // Dropdown Bayar
            document.getElementById('pay-nama').innerHTML = appData.warga.map(w => `<option value="${w.nama}">${w.nama}</option>`).join('');

            // Table Bayar
            document.getElementById('list-pembayaran').innerHTML = appData.pembayaran.map(p => `
                <tr class="border-b">
                    <td class="p-3">${p.nama}</td>
                    <td class="p-3">${p.tgl}</td>
                    <td class="p-3 font-bold">Rp ${p.jumlah.toLocaleString()}</td>
                    <td class="p-3"><button onclick="deletePayment(${p.id})" class="text-red-400">×</button></td>
                </tr>
            `).join('');

            // Monitoring Status
            const sudahBayarNames = appData.pembayaran.map(p => p.nama);
            document.getElementById('status-belum').innerHTML = appData.warga.filter(w => !sudahBayarNames.includes(w.nama)).map(w => `
                <li class="flex justify-between p-2 bg-white rounded shadow-sm"><span>${w.nama}</span> <span class="text-xs text-red-500 font-bold italic">BELUM LUNAS</span></li>
            `).join('');
            document.getElementById('status-lunas').innerHTML = appData.pembayaran.map(p => `
                <li class="flex justify-between p-2 bg-white rounded shadow-sm"><span>${p.nama}</span> <span class="text-xs text-green-600 font-bold">LUNAS ✓</span></li>
            `).join('');

            // Kas Table
            document.getElementById('list-kas').innerHTML = `
                <table class="w-full text-left">
                    <thead><tr><th>Tipe</th><th>Jumlah</th><th>Tgl</th></tr></thead>
                    <tbody>${appData.pengeluaran.map(k => `<tr><td>${k.tipe}</td><td class="text-red-500">-Rp ${k.jumlah.toLocaleString()}</td><td>${k.tgl}</td></tr>`).join('')}</tbody>
                </table>
            `;

            // Dashboard Stats
            const totalMasuk = appData.pembayaran.reduce((a, b) => a + b.jumlah, 0);
            const totalKeluar = appData.pengeluaran.reduce((a, b) => a + b.jumlah, 0);
            document.getElementById('card-warga').innerText = appData.warga.length;
            document.getElementById('card-masuk').innerText = `Rp ${totalMasuk.toLocaleString()}`;
            document.getElementById('card-keluar').innerText = `Rp ${totalKeluar.toLocaleString()}`;

            updateCharts(totalMasuk, totalKeluar);
        }

        // --- CHARTS ---
        let chart1, chart2;
        function updateCharts(masuk, keluar) {
            if(chart1) chart1.destroy();
            if(chart2) chart2.destroy();

            chart1 = new Chart(document.getElementById('chartIpl'), {
                type: 'pie',
                data: {
                    labels: ['Sisa Kas', 'Pengeluaran'],
                    datasets: [{ data: [masuk - keluar, keluar], backgroundColor: ['#10b981', '#ef4444'] }]
                }
            });

            chart2 = new Chart(document.getElementById('chartStatus'), {
                type: 'bar',
                data: {
                    labels: ['Sudah Bayar', 'Belum Bayar'],
                    datasets: [{
                        label: 'Orang',
                        data: [appData.pembayaran.length, appData.warga.length - appData.pembayaran.length],
                        backgroundColor: '#3b82f6'
                    }]
                }
            });
        }

        function deleteWarga(id) {
            appData.warga = appData.warga.filter(w => w.id !== id);
            syncToCloud();
        }

        // --- EXPORT ---
        function exportToExcel(type) {
            let dataToExport = type === 'ipl' ? appData.pembayaran : appData.pengeluaran;
            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook